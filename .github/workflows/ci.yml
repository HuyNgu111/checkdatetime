name: Java CI with JUnit and JaCoCo Coverage

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]
  workflow_dispatch:

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: â˜• Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        
    - name:  Verify project structure
      run: |
        echo "=== Project Structure ==="
        ls -la
        echo "=== Source files ==="
        ls -la src/ 2>/dev/null || echo "No src directory"
        echo "=== Test file ==="
        ls -la DateTimeCheckerTest.java 2>/dev/null || echo "Test file not in root"
        ls -la test/DateTimeCheckerTest.java 2>/dev/null || echo "Test file not in test/"
        echo "=== Library files ==="
        ls -la lib/ 2>/dev/null || echo "No lib directory"
        
    - name: ğŸ“ Create build directories
      run: |
        mkdir -p build/classes
        mkdir -p build/test-classes
        mkdir -p coverage
        
    - name: ğŸ”¨ Compile main source
      run: |
        echo "Compiling DateTimeChecker.java..."
        javac -encoding UTF-8 -cp "lib/*" -d build/classes src/DateTimeChecker.java
        echo "âœ“ Main source compiled"
        
    - name: ğŸ§ª Compile test source
      run: |
        echo "Compiling test..."
        # Thá»­ compile test file á»Ÿ root trÆ°á»›c
        if [ -f "DateTimeCheckerTest.java" ]; then
          echo "Found test in root directory"
          javac -encoding UTF-8 -cp "lib/*:build/classes" -d build/test-classes DateTimeCheckerTest.java
        elif [ -f "test/DateTimeCheckerTest.java" ]; then
          echo "Found test in test/ directory, copying to root..."
          cp test/DateTimeCheckerTest.java .
          javac -encoding UTF-8 -cp "lib/*:build/classes" -d build/test-classes DateTimeCheckerTest.java
        else
          echo "âŒ Test file not found!"
          exit 1
        fi
        echo "âœ“ Test compiled"
        
    - name: ğŸš€ Run JUnit tests with JaCoCo coverage
      run: |
        echo "Running tests with coverage..."
        java -javaagent:lib/jacoco/jacocoagent.jar=destfile=coverage/jacoco.exec \
          -cp "build/classes:build/test-classes:lib/*" \
          org.junit.platform.console.ConsoleLauncher \
          --select-class=DateTimeCheckerTest \
          --details=summary
        echo "âœ“ Tests completed"
        
    - name: ğŸ“Š Generate coverage report
      run: |
        echo "Generating coverage reports..."
        java -jar lib/jacoco/jacococli.jar report coverage/jacoco.exec \
          --classfiles build/classes \
          --sourcefiles src \
          --html coverage/html \
          --xml coverage/coverage.xml \
          --csv coverage/coverage.csv
        echo "âœ“ Coverage generated"
        
    - name: ğŸ“ˆ Display coverage summary
      run: |
        echo "=== Coverage Summary ==="
        if [ -f coverage/coverage.csv ]; then
          head -5 coverage/coverage.csv
        fi
        
    - name: ğŸ“¤ Upload coverage report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: coverage-report
        path: coverage/html/
        retention-days: 30
        
    - name: âœ… Build success
      if: success()
      run: |
        echo "========================================="
        echo "âœ… BUILD SUCCESSFUL!"
        echo "========================================="
        echo "âœ“ Compilation: PASSED"
        echo "âœ“ Tests: PASSED"
        echo "âœ“ Coverage: GENERATED"
        echo "========================================="
        
    - name: âŒ Build failure
      if: failure()
      run: |
        echo "========================================="
        echo "âŒ BUILD FAILED!"
        echo "Check logs above for details"
        echo "========================================="
